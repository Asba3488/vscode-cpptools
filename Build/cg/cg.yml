parameters:
- name: preRelease
  displayName: Pre-release
  type: boolean
  default: false
  values:
    - true
    - false
- name: correctBinaryVersion
  displayName: Binary version in CMakeLists.txt is correct
  type: string
  default: no
  values:
    - yes
    - no
- name: currentVersion
  displayName: Current version
  type: string
  default: '1.xx.x'
- name: releaseVersion
  displayName: Release version
  type: string
  default: '1.xx.x'
- name: githubBranch
  displayName: GitHub branch override (if different from release/insiders)
  type: string
  default: ''

stages:
- stage: verify
  jobs:
  - job: verify
    pool:
      vmImage: 'windows-latest'
    steps:
    - powershell: |
        Write-Host "correctBinaryVersion = $(correctBinaryVersion)"
        Write-Host "##vso[task.logissue type=error]correctBinaryVersion must be set to 'yes'."
        exit 1
      displayName: self-attestation
      condition: eq('${{ parameters.correctBinaryVersion }}', 'no')

- stage: build
  jobs:
  - job: build
    pool:
      vmImage: 'windows-latest'
    steps:
      - ${{ each config in ['windows-x86', 'windows-x64', 'windows-arm64', 'linux-x64', 'linux-arm32', 'linux-arm64', 'macos-x64', 'macos-arm64', 'alpine-x64', 'alpine-arm64'] }}:
        - powershell: |
            Write-Host "config = $(config)"
            Write-Host "preRelease = $(preRelease)"
            Write-Host "correctBinaryVersion = $(correctBinaryVersion)"
            Write-Host "currentVersion = $(currentVersion)"
            Write-Host "releaseVersion = $(releaseVersion)"
            Write-Host "githubBranch = $(githubBranch)"
          displayName: check ${{ config }}