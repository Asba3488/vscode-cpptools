parameters:
- name: preRelease
  displayName: Pre-release
  type: boolean
  default: false
  values:
    - true
    - false
- name: correctBinaryVersion
  displayName: Binary version in CMakeLists.txt is correct
  type: string
  default: no
  values:
    - yes
    - no
- name: releaseVersion
  displayName: Release version
  type: string
  default: '1.xx.x'
- name: githubBranch
  displayName: GitHub branch or commit hash
  type: string
  default: 'release'
  values:
  - release
  - insiders

stages:
- stage: verify
  jobs:
  - job: verify
    pool:
      vmImage: 'windows-latest'
    steps:
    - checkout: none
    - ${{ if eq(parameters.correctBinaryVersion, 'no') }}:
      - 'binary version in CMakeLists.txt needs to be updated before the pipeline can be scheduled'
    - ${{ if and(eq(parameters.githubBranch, 'release'), eq(parameters.preRelease, false)) }}:
      - 'release branch build marked as pre-release'
    - ${{ if and(eq(parameters.githubBranch, 'insiders'), eq(parameters.preRelease, true)) }}:
      - 'insiders branch build marked as release'
    - ${{ if and(ne(parameters.githubBranch, 'release'), ne(parameters.githubBranch, 'insiders'), or(eq(parameters.preRelease, false), not(contains(parameters.releaseVersion, '-dogfood')))) }}:
      - 'When using commit hashes or a branch other than release or insiders, the build must be marked as pre-release and have -dogfood in the release version'


- stage: build
  jobs:
  - job: build
    pool:
      vmImage: 'windows-latest'
    steps:
    - checkout: none

    - template: test.yml
      parameters:
        SomeVar: 'this is passed to the template'
