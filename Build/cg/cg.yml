parameters:
- name: config
  type: object
  values:
    - os: windows
      arch: x86
    - os: windows
      arch: x64
    - os: windows
      arch: arm64
    - os: macOS
      arch: x64
    - os: linux
      arch: x64
- name: preRelease
  displayName: Pre-release
  type: boolean
  default: false
  values:
    - true
    - false
- name: correctBinaryVersion
  displayName: Binary version in CMakeLists.txt is correct
  type: string
  default: no
  values:
    - yes
    - no

stages:
- stage: verify
  jobs:
  - job: verify
    pool:
      vmImage: 'windows-latest'
    steps:
    - powershell: |
        Write-Host "correctBinaryVersion = $(correctBinaryVersion)"
        Write-Host "##vso[task.logissue type=error]correctBinaryVersion must be set to 'yes'."
        exit 1
      displayName: self-attestation
      condition: eq('${{ parameters.correctBinaryVersion }}', 'no')

- stage: build
  jobs:
  - job: build
    pool:
      vmImage: 'windows-latest'
    steps:
      - ${{ each config in parameters.config }}:
        - powershell: |
            Write-Host "config.os = $(config.os)"
            Write-Host "config.arch = $(config.arch)"
            Write-Host "preRelease = $(preRelease)"
          displayName: check ${{ config.os }} ${{ config.arch }}